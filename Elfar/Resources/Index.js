var dataTable,chart,headers={2:'Host',3:'Application',4:'Code',5:'Type',7:'Date'},data=[];function showChart(){var isDate=$(this).val()==="Date";var type=$("#dialog #chart-type");type.attr("disabled",isDate);if(isDate)type.val("Date");drawChart(this)}function changeChart(){drawChart($("#dialog #filter")[0])}function drawChart(ddl){if(chart)chart.destroy();var type=$("#dialog #chart-type").val();switch(type){case"Pie Chart":type="pie";break;case"Column Chart":type="column";break;default:type="areaspline";break;}var series;switch(ddl.selectedIndex){case 0:series=[{name:'Errors',type:type,data:data.timeline}];break;case 1:series=getSeries(data.hosts,type);break;case 2:series=getSeries(data.applications,type);break;case 3:series=getSeries(data.codes,type);break;case 4:series=getSeries(data.types,type);break}var options={chart:{renderTo:'graph'},title:{text:''},xAxis:{},yAxis:{title:{text:'Errors'},min:0},tooltip:{},series:series};switch(type){case'areaspline':options.xAxis.type="datetime";options.tooltip.shared=true;break;case'column':options.xAxis.categories=series.select(function(s){var name=s.name;delete s.name;return name});options.series=[{type:type,name:'Errors',data:series.select(function(s){return s.data[0]}),dataLabels:{enabled:false}}];options.legend={enabled:false};options.tooltip.formatter=function(){return '<b>'+this.point.category+': </b>'+this.y};break;case'pie':options.plotOptions={pie:{allowPointSelect:true,cursor:'pointer',dataLabels:{enabled:false},showInLegend:true}};options.tooltip.formatter=function(){return '<b>'+this.point.name+': </b>'+this.percentage.toFixed(1)+'%'};break}chart=new Highcharts.Chart(options)}function getSeries(obj,type){var series=[];var array=obj[type];if(type==='pie')series.push({type:'pie',data:array});else $.each(array,function(i,obj){series.push({name:obj.key.toString(),type:type,data:obj})});return series}function getChartData(){if(dataTable.length){dataTable.$("tr").each(processRow);data=new ChartData(data)}}function processRow(){var obj={};$('td',this).each(function(i){var header=headers[i];if(header){var value=this.innerHTML;if(i==3&&!value) value='<em>null</em>';if(i==4) value=value?Number(value):0;if(i==7){var parts=value.match(/\d+/g);value=new Date(parts[2],parts[1]-1,parts[0])}obj[header]=value}});data.push(obj)}function ChartData(data){this.timeline=data.groupBy(byDate).orderBy(byKey).select(selectDate);this.hosts=new Series(data,function(o){return o.Host});this.applications=new Series(data,function(o){return o.Application});this.codes=new Series(data,function(o){return o.Code});this.types=new Series(data,function(o){return o.Type})}function Series(data, func){var g=data.groupBy(func);this.areaspline=g.select(function(g){return new Grouping(g.key, g.groupBy(byDate).orderBy(byKey).select(selectDate))});this.column=g.select(function(g){return new Grouping(g.key, [g.length])});this.pie=g.select(function(g){return [g.key.toString(),g.length/data.length]})}function byDate(o){return o.Date}function byKey(g){return g.key}function selectDate(g){return [Number(g.key),g.length]}$(function(){dataTable=$("table").bind('draw',bindEvents).dataTable({"bJQueryUI":true,"sPaginationType":"full_numbers","aoColumnDefs":[{"bSortable":false,"aTargets":[0,7]}],"aLengthMenu":[[10,25,50,100,250,500,-1],[10,25,50,100,250,500,"All"]]});$("#select-all").change(function(){checkboxes().attr('checked',this.checked);bindEvents()});$("#delete").click(function(){return confirm("Are you sure you want to delete the selected error log(s)?")});$("#charts").click(function(){dialog_open();$("#dialog #filter").change()});getChartData();$("#dialog").dialog("option","height",462);$("#dialog").dialog("option","close",function(){dialog_close();chart=null;$("#dialog #filter").val("Date");$("#dialog #chart-type").val("Timeline")});$("#dialog #filter").change(showChart);$("#dialog #chart-type").change(changeChart);$("#notify").dialog({autoOpen:false,dialogClass:"notify",show:"fade",hide:"fade",position:["right","bottom"]});$.connection.errorLogHub.notify=function(){$("#notify").dialog("open");setTimeout(function(){$("#notify").dialog("close")},5000)};$.connection.hub.start()})